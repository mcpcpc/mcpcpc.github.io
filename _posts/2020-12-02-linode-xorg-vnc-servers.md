---
layout: post
title: Xorg and VNC servers on Linode VM
---

Configuring a minimal VNC and Xorg Server on a Linode virtual machine.

As part of my recent efforts to expand [xwm](http://github.com/mcpcpc/xwm) to 
other distribution platforms, I decided to purchase a Linode virtual machine
(VM). The sole purpose of this VM is to host Docker, along with various other 
operating system containers (e.g. Debian, CentOS, Arch Linux, Void Linux, etc). 
I opted for a 5 USD shared instance which, while only having 1GB of RAM and 1 
Core, is surprisingly fast and made pushing cross-platform package updates a 
breeze. 

At some point I decided that it would be a good idea to run GUI-based 
applications on my shiny new VM. While the process for getting a minimal Xorg 
server up and running was fairly straight forward, I encounter a few "snags" 
that I figured would be worth sharing. Also, if it any point I decide to repeat 
this process on a different VM, I at least won't waste any time figuring out 
what went wrong.

## Xorg Server

To begin, let's make sure that we have an SSH session going and are logged in as 
a regular user (a.k.a non-root). This regular user should (1) be part of the 
sudoers group and (2) be a member of the audio and video groups. If you are not 
sure which groups your regular user belongs to, you can always confirm with the 
`groups` command. If you are missing a group you can add one or multiple with the 
following command, replacing <username> with your regular user name:

```bash
usermod -a -G audio video mcpcpc
```

We then need to verify that we have all of the prerequisite packages installed. 
Note that I specify `xwm` in the application list below, but this will also work 
with many other window managers (e.g. cwm, dwm, evilwm, etc.):

```bash
sudo apt update
sudo apt upgrade
sudo apt install xinit x11vnc xwm
```

With all of the prerequisite packages installed, we need to tell xorg which 
window manager to run when starting the server. For this, we will create an 
.xinitrc file in the regular user's HOME directory: 

```bash
echo "exec xwm" > ~/.xinitrc
```

At this point, we are almost there. We could try to start the Xorg server as a 
regular user, but the server will most likely complain and throw off multiple 
errors. To fix these errors, we need to to change some of the server's default
permissions. Begin by opening the Xwrapper.config file for editting:

```bash
sudo vim /etc/X11/Xwrapper.config
```

Once opened, change the `allowed_users=` value from "console" to "anybody". This
will allow a regular user from a non-TTY (e.g. over SSH) to start the Xorg 
server. Once changed, you'r config file should like something like the one
below:

```
# Xwrapper.config (Debian X Window System server wrapper configuration file)
#
# This file was generated by the post-installation script of the
# xserver-xorg-legacy package using values from the debconf database.
#
# See the Xwrapper.config(5) manual page for more information.
#
# This file is automatically updated on upgrades of the xserver-xorg-legacy
# package *only* if it has not been modified since the last upgrade of that
# package.
#
# If you have edited this file but would like it to be automatically updated
# again, run the following command as root:
#   dpkg-reconfigure xserver-xorg-legacy
#allowed_users=console
allowed_users=anybody
needs_root_rights=yes
```

Remember to save and close the modified Xwrapper.config file mentioned above. At 
this point we, can test the Xorg server:

```bash
startx
```

If all goes well, the server should start right away.  If it fails, inspect the 
log file, typically located in the ~/.local/share/xorg/ directory. If it starts
succesfully, we can force it to shutdown with `Ctrl+C`.

Of course, manually starting and stopping the Xorg server is not a practical 
solution.  Instead, we will want to specify the server to start automagically
after user login. A simple way of doing this is to add a line to to our ~/.bashrc 
file, which will check for tty1 and, if it matches, run the `startx` command:

```shell
echo '[ -z "$DISPLAY" ] && [ "$(tty)" = /dev/tty1 ] && startx' >> ~/.bashrc
```

If you are manually typing in the above command, take note of the `>>`, as 
opposed to the `>` used previously. The next time you restart and/or login as 
your regular user, the Xorg server should already be running. 

## x11vnc

At this point, x11vnc should already be installed and, by just passing the 
`x11vnc` command, should run without a problem (by default, x11vnc will start
the VNC service on port "5900"). The one caveat that you might notice is when
you close the VNC session, the x11vnc service terminates as well. To have 
x11vnc running constantly, even after disconnect, we should pass the `--loop`
argument.  If we also pass `--bg`, x11vnc will continue to run forever as a 
background process:

```bash
x11vnc --loop --bg
``` 

Another issue to address is security. At this point, any unauthorized user 
with your IP address could potentially start a VNC session and have complete
access to the filesystem on your VM. To prevent this from happening, we will 
tell x11vnc to generate a secure key and prompt the user for this key on each 
new session. To generate a secure key, we need to first run x11vnc with the 
`-storepasswd` argument, which will prompt you for a plaintext password and 
path to store the password (I would recommend leaving the default path as 
~/.vnc/passwd):

```bash
x11vnc -storepasswd
```

We can now specify the `-usepw` argument, which will prompt the user at
the beginning of each VNC session to enter the password generated in the
previous step:

```bash
x11vnc -usepw --loop --bg
```

## Conclusions

At this point, we should have both Xorg and VNC servers running. Some closing
remarks:

1. There are far more secure ways to go about protecting your VNC session. 
   **If privacy is important to you, then do not use the proposed password 
   method mentioned above**.
2. Running x11vnc in the background is nice, but I would not advise leaving it 
   running 24 hours, 7 days a week. A better solution is to start the VNC server
   on demand. For this, I like to create command alias:

   ```shell
   echo 'alias svnc="x11vnc -usepw --loop"' > ~/.bashrc
   ```
